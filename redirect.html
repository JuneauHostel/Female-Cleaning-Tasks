<!DOCTYPE html>
<html>
<head>
    <title>Logging Chore...</title>
</head>
<body>
    <p>Fetching chore, please wait...</p>
    <form id="choreForm" action="https://script.google.com/macros/s/AKfycbyOyXhaR4VYcBJ27U5xDIVM5o5P_o5X0Opcck8kY6nE_ouZ-_K1glIJSR0hBzUqvxgFtA/exec" method="POST">
        <input type="hidden" name="date" id="dateInput">
        <input type="hidden" name="task" id="taskInput">
    </form>
    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyOyXhaR4VYcBJ27U5xDIVM5o5P_o5X0Opcck8kY6nE_ouZ-_K1glIJSR0hBzUqvxgFtA/exec';
        const urlParams = new URLSearchParams(window.location.search);

        if (urlParams.get('action') === 'getTask') {
            // Fetch random task
            fetch(`${SCRIPT_URL}?action=getTask`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const date = new Date().toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                        const task = data.task;

                        // Set form inputs
                        document.getElementById('dateInput').value = date;
                        document.getElementById('taskInput').value = task;

                        // Submit form to log task
                        const form = document.getElementById('choreForm');
                        fetch(form.action, {
                            method: 'POST',
                            body: new FormData(form)
                        })
                            .then(response => response.json())
                            .then(logData => {
                                if (logData.status === 'success') {
                                    document.body.innerHTML = `
                                        <p>Chore logged: ${task} on ${date}</p>
                                        <a href="https://juneauhostel.github.io/Female-Cleaning-Tasks/">Scan another QR code</a>
                                    `;
                                } else {
                                    document.body.innerHTML = `
                                        <p>Error logging chore: ${logData.message}</p>
                                        <a href="https://juneauhostel.github.io/Female-Cleaning-Tasks/">Try again</a>
                                    `;
                                }
                            })
                            .catch(error => {
                                document.body.innerHTML = `
                                    <p>Error logging chore: ${error.message}</p>
                                    <a href="https://juneauhostel.github.io/Female-Cleaning-Tasks/">Try again</a>
                                `;
                            });

                        // Submit form
                        form.submit();
                    } else {
                        document.body.innerHTML = `
                            <p>Error fetching chore: ${data.message}</p>
                            <a href="https://juneauhostel.github.io/Female-Cleaning-Tasks/">Try again</a>
                        `;
                    }
                })
                .catch(error => {
                    document.body.innerHTML = `
                        <p>Error fetching chore: ${error.message}</p>
                        <a href="https://juneauhostel.github.io/Female-Cleaning-Tasks/">Try again</a>
                    `;
                });
        } else {
            document.body.innerHTML = `
                <p>Invalid action</p>
                <a href="https://juneauhostel.github.io/Female-Cleaning-Tasks/">Go back</a>
            `;
        }
    </script>
</body>
</html>
